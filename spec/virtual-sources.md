# Virtual Sources Specification

**Version**: 0.1.0-draft
**Status**: Draft
**Date**: 2026-01-13

## 1. Overview

Virtual sources are data sources generated by the controller itself, rather than by external devices. They enable the controller to produce patterns, effects, and data visualizations without requiring external hardware.

### 1.1 Use Cases

1. **Pattern Generators**: Animated effects like rainbow, flame, chase, cylon eye, sparkle, etc.
2. **Data Visualizers**: Transform scalar or array data into visual representations (bar graphs, heatmaps)
3. **Test Patterns**: Diagnostic patterns for testing sinks
4. **Composite Sources**: Combine or layer multiple sources

### 1.2 Design Principles

- Virtual sources appear in the controller UI alongside discovered physical sources
- Virtual sources can be routed to sinks using the same routing mechanism as physical sources
- Each virtual source type has configurable parameters exposed as controls
- Virtual sources only generate data when routed to at least one sink (lazy evaluation)
- The system should be extensible for adding new effect types

## 2. Virtual Source Types

### 2.1 Pattern Generators

Pattern generators produce animated RGB pixel data.

#### 2.1.1 Common Controls

All pattern generators share these base controls:

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `speed` | number | 1.0 | Animation speed multiplier (0.1 - 10.0) |
| `brightness` | number | 1.0 | Output brightness (0.0 - 1.0) |
| `reverse` | boolean | false | Reverse animation direction |
| `mirror` | boolean | false | Mirror pattern around center |
| `blend_mode` | enum | `replace` | How to combine with other sources |

#### 2.1.2 Rainbow

Smooth color gradient cycling through the spectrum.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `wavelength` | number | 1.0 | Number of full spectrum cycles across the strip |
| `saturation` | number | 1.0 | Color saturation (0.0 - 1.0) |

#### 2.1.3 Chase

Moving segment(s) of color.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `color` | color | `#FFFFFF` | Chase segment color |
| `background` | color | `#000000` | Background color |
| `length` | number | 5 | Length of chase segment in pixels |
| `spacing` | number | 10 | Spacing between segments (0 = single segment) |
| `fade` | number | 0.5 | Tail fade length (0.0 - 1.0 of length) |

#### 2.1.4 Cylon / Larson Scanner

Back-and-forth scanning effect.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `color` | color | `#FF0000` | Scanner color |
| `background` | color | `#000000` | Background color |
| `width` | number | 5 | Width of the scanner |
| `fade` | number | 0.8 | Tail fade intensity (0.0 - 1.0) |

#### 2.1.5 Flame / Fire

Simulated fire effect.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `cooling` | number | 55 | How quickly flames cool (20 - 100) |
| `sparking` | number | 120 | Chance of new sparks (50 - 200) |
| `palette` | enum | `fire` | Color palette: `fire`, `ice`, `forest`, `custom` |
| `color_low` | color | `#000000` | Low temperature color (if palette=custom) |
| `color_mid` | color | `#FF4400` | Mid temperature color (if palette=custom) |
| `color_high` | color | `#FFFF00` | High temperature color (if palette=custom) |

#### 2.1.6 Sparkle / Twinkle

Random twinkling points of light.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `color` | color | `#FFFFFF` | Sparkle color |
| `background` | color | `#000000` | Background color |
| `density` | number | 0.1 | Probability of sparkle per pixel per frame |
| `fade_speed` | number | 0.9 | How quickly sparkles fade (0.0 - 1.0) |
| `random_color` | boolean | false | Use random colors instead of fixed |

#### 2.1.7 Solid Color

Static solid color fill.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `color` | color | `#FFFFFF` | Fill color |

#### 2.1.8 Gradient

Static or animated gradient between colors.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `colors` | array[color] | `["#FF0000", "#0000FF"]` | Gradient color stops |
| `animate` | boolean | false | Animate the gradient |
| `mode` | enum | `linear` | Gradient mode: `linear`, `radial`, `reflected` |

#### 2.1.9 Breathe / Pulse

Pulsing brightness effect.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `color` | color | `#FFFFFF` | Pulse color |
| `min_brightness` | number | 0.0 | Minimum brightness |
| `max_brightness` | number | 1.0 | Maximum brightness |
| `waveform` | enum | `sine` | Waveform: `sine`, `triangle`, `square`, `sawtooth` |

#### 2.1.10 Strobe

Flashing strobe effect.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `color` | color | `#FFFFFF` | Strobe color |
| `on_time` | number | 50 | On duration in milliseconds |
| `off_time` | number | 50 | Off duration in milliseconds |

#### 2.1.11 Noise / Perlin

Organic flowing noise patterns.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `scale` | number | 0.1 | Noise scale (smaller = larger features) |
| `palette` | enum | `rainbow` | Color palette for noise values |
| `octaves` | number | 3 | Noise complexity (1 - 6) |

### 2.2 Data Visualizers

Data visualizers transform numeric data into visual representations.

#### 2.2.1 Data Input Methods

Virtual sources that visualize data need a way to receive that data:

1. **API Endpoint**: POST data to `/api/virtual-sources/<id>/data`
2. **Internal Feed**: Subscribe to controller-internal data (CPU, memory, etc.)
3. **Expression**: Evaluate a mathematical expression over time

#### 2.2.2 Bar Graph (Scalar to RGB)

Displays a single scalar value as a filled bar.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `value` | number | 0.0 | Current value (0.0 - 1.0), or set via API |
| `direction` | enum | `left_to_right` | Fill direction |
| `color_mode` | enum | `solid` | `solid`, `gradient`, `threshold` |
| `color` | color | `#00FF00` | Bar color (if solid) |
| `gradient_low` | color | `#00FF00` | Low value color (if gradient) |
| `gradient_high` | color | `#FF0000` | High value color (if gradient) |
| `thresholds` | array | `[0.7, 0.9]` | Threshold levels (if threshold mode) |
| `threshold_colors` | array[color] | `["#00FF00", "#FFFF00", "#FF0000"]` | Colors for threshold bands |
| `background` | color | `#000000` | Background color |
| `show_peak` | boolean | false | Show peak hold indicator |
| `peak_hold_time` | number | 1.0 | Peak hold time in seconds |

Directions: `left_to_right`, `right_to_left`, `center_out`, `edges_in`

#### 2.2.3 Multi-Bar (Array to RGB)

Displays an array of scalar values as multiple bar graphs.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `values` | array[number] | `[]` | Array of values (0.0 - 1.0 each) |
| `bar_width` | number | 0 | Pixels per bar (0 = auto-fit) |
| `bar_gap` | number | 1 | Pixels between bars |
| `direction` | enum | `bottom_to_top` | Bar fill direction |
| `color_mode` | enum | `solid` | Same as Bar Graph |
| (other bar graph controls) | | | |

#### 2.2.4 Heatmap

Maps an array of values to colors using a palette.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `values` | array[number] | `[]` | Array of values (0.0 - 1.0) |
| `palette` | enum | `thermal` | `thermal`, `viridis`, `plasma`, `rainbow`, `grayscale` |
| `interpolate` | boolean | true | Smooth interpolation between values |

#### 2.2.5 VU Meter

Audio-style level meter with multiple segments.

| Control | Type | Default | Description |
|---------|------|---------|-------------|
| `value` | number | 0.0 | Current level (0.0 - 1.0) |
| `segments` | number | 10 | Number of segments |
| `colors` | array[color] | `["#00FF00", "#FFFF00", "#FF0000"]` | Segment colors |
| `peak` | boolean | true | Show peak indicator |
| `decay` | number | 0.95 | Decay rate for smooth falloff |

### 2.3 Built-in Data Feeds

The controller can provide internal data feeds:

| Feed ID | Description | Output Type |
|---------|-------------|-------------|
| `system.cpu` | CPU usage percentage | scalar (0.0 - 1.0) |
| `system.cpu_cores` | Per-core CPU usage | array[scalar] |
| `system.memory` | Memory usage percentage | scalar |
| `system.network_rx` | Network receive rate | scalar (normalized) |
| `system.network_tx` | Network transmit rate | scalar (normalized) |
| `system.disk` | Disk usage percentage | scalar |
| `time.seconds` | Seconds (0-59) | scalar |
| `time.minutes` | Minutes (0-59) | scalar |
| `time.hours` | Hours (0-23) | scalar |
| `time.day_progress` | Progress through day | scalar (0.0 - 1.0) |

## 3. API Endpoints

### 3.1 Virtual Source Management

#### List Virtual Sources

```
GET /api/virtual-sources
```

Response:
```json
{
  "virtual_sources": [
    {
      "id": "vs-rainbow-1",
      "type": "rainbow",
      "name": "Rainbow Effect",
      "enabled": true,
      "output_dimensions": [60],
      "frame_rate": 30,
      "controls": { ... }
    }
  ]
}
```

#### Create Virtual Source

```
POST /api/virtual-sources
```

Request:
```json
{
  "type": "flame",
  "name": "Fire Effect",
  "output_dimensions": [60],
  "frame_rate": 30,
  "controls": {
    "cooling": 60,
    "sparking": 100
  }
}
```

#### Update Virtual Source

```
PUT /api/virtual-sources/<id>
```

#### Delete Virtual Source

```
DELETE /api/virtual-sources/<id>
```

#### Push Data to Visualizer

```
POST /api/virtual-sources/<id>/data
```

Request:
```json
{
  "value": 0.75
}
```

Or for arrays:
```json
{
  "values": [0.1, 0.5, 0.8, 0.3]
}
```

### 3.2 Integration with Routes

Virtual sources use the same routing mechanism:

```
POST /api/routes
```

Request:
```json
{
  "name": "Fire to Strip",
  "source_id": "vs-flame-1",
  "sink_id": "serial-led-strip-abc123",
  "enabled": true
}
```

## 4. Implementation Architecture

### 4.1 Class Hierarchy

```
VirtualSource (abstract base)
├── PatternGenerator (abstract)
│   ├── RainbowPattern
│   ├── ChasePattern
│   ├── CylonPattern
│   ├── FlamePattern
│   ├── SparklePattern
│   ├── SolidPattern
│   ├── GradientPattern
│   ├── BreathePattern
│   ├── StrobePattern
│   └── NoisePattern
└── DataVisualizer (abstract)
    ├── BarGraph
    ├── MultiBar
    ├── Heatmap
    └── VUMeter
```

### 4.2 Virtual Source Interface

```python
class VirtualSource:
    id: str
    name: str
    source_type: str
    output_dimensions: list[int]
    frame_rate: float
    controls: ControlRegistry

    def start(self) -> None: ...
    def stop(self) -> None: ...
    def render(self, time_delta: float) -> np.ndarray: ...
    def set_data(self, data: Any) -> None: ...  # For visualizers
```

### 4.3 Frame Generation

Virtual sources generate frames at their configured frame rate. The controller:

1. Maintains a render loop for each active virtual source
2. Only renders when the source is routed to at least one sink
3. Distributes frames through the normal routing mechanism

## 5. Design Decisions

### D1: Output Dimensions

**Decision:** Configurable per source - can be fixed or adaptive to sink dimensions.

Each virtual source has an `adaptive_dimensions` boolean:
- `false`: Uses fixed `output_dimensions` set at creation
- `true`: Adapts to sink dimensions when routed

### D2: Multiple Sinks

**Decision:** Render separately for each sink.

When a virtual source is routed to multiple sinks with different dimensions, the source renders independently for each sink at the sink's native dimensions. This ensures optimal quality without scaling artifacts.

### D3: Data Visualizer Input

**Decision:** Support HTTP API, internal feeds, and MQTT/WebSocket subscriptions.

- **HTTP API**: Push data via `POST /api/virtual-sources/<id>/data`
- **Internal feeds**: Subscribe to controller data (CPU, memory, time, etc.)
- **MQTT**: Subscribe to external MQTT topics
- **WebSocket**: Real-time data push via WebSocket connection

### D4: Expression Evaluation

**Decision:** No expression evaluation - keep implementation simple.

Use the API or internal feeds for dynamic values. Complex expressions can be implemented externally and pushed via API.

### D5: Persistence

**Decision:** Save to config file.

Virtual source configurations are saved to the controller's YAML config file and restored on startup.

### D6: UI Representation

**Decision:** Mixed with physical sources on Sources page with visual distinction.

Virtual sources appear in the same list as physical sources but with a distinct visual indicator (icon, badge, or color) to differentiate them.

### D7: Layering/Compositing

**Decision:** Compositing via a separate "compositor" virtual source.

A special `compositor` virtual source type can take multiple inputs (other sources) and blend them with configurable blend modes. This keeps the routing model simple (one source per route) while enabling layering.

### D8: Color Palettes

**Decision:** Both built-in palettes and custom palette definitions.

- Built-in palettes: `rainbow`, `fire`, `ice`, `ocean`, `forest`, `thermal`, `viridis`, `plasma`, `grayscale`
- Custom palettes: User-defined as arrays of color stops
- Palettes are stored globally and referenced by name in effects
