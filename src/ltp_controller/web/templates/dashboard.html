{% extends "base.html" %}

{% block title %}Dashboard - LTP Controller{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard</h1>
    <button class="btn" onclick="refreshDiscovery()" id="refresh-btn">Refresh Discovery</button>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="sources-stat">{{ sources|selectattr('online')|list|length }} / {{ sources|length }}</div>
        <div class="stat-label">Sources Online</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="sinks-stat">{{ sinks|selectattr('online')|list|length }} / {{ sinks|length }}</div>
        <div class="stat-label">Sinks Online</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ routes|selectattr('enabled')|list|length }} / {{ routes|length }}</div>
        <div class="stat-label">Routes Active</div>
    </div>
</div>

<div class="dashboard-grid">
    <section class="panel">
        <h2>Sources</h2>
        {% if sources %}
        <ul class="device-list">
            {% for source in sources %}
            <li class="device-item {% if source.online %}online{% else %}offline{% endif %}" data-source-id="{{ source.id }}">
                <span class="status-dot"></span>
                <div class="device-info">
                    <strong>{{ source.name }}</strong>
                    <span class="device-meta">{{ source.description or 'No description' }}</span>
                </div>
                <span class="device-address">{{ source.host }}:{{ source.port }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No sources discovered</p>
        {% endif %}
        <a href="/sources" class="btn">View All Sources</a>
    </section>

    <section class="panel">
        <h2>Sinks</h2>
        {% if sinks %}
        <ul class="device-list">
            {% for sink in sinks %}
            <li class="device-item {% if sink.online %}online{% else %}offline{% endif %}" data-sink-id="{{ sink.id }}">
                <span class="status-dot"></span>
                <div class="device-info">
                    <strong>{{ sink.name }}</strong>
                    <span class="device-meta">{{ sink.description or 'No description' }}</span>
                </div>
                <span class="device-address">{{ sink.host }}:{{ sink.port }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No sinks discovered</p>
        {% endif %}
        <a href="/sinks" class="btn">View All Sinks</a>
    </section>
</div>

<section class="panel">
    <h2>Active Routes</h2>
    {% if routes %}
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Source</th>
                <th>Sink</th>
                <th>Status</th>
                <th>Mode</th>
            </tr>
        </thead>
        <tbody>
            {% for route in routes %}
            <tr>
                <td>{{ route.name }}</td>
                <td>
                    {% for source in sources if source.id == route.source_id %}
                        {{ source.name }}
                    {% else %}
                        {{ route.source_id[:8] }}...
                    {% endfor %}
                </td>
                <td>
                    {% for sink in sinks if sink.id == route.sink_id %}
                        {{ sink.name }}
                    {% else %}
                        {{ route.sink_id[:8] }}...
                    {% endfor %}
                </td>
                <td>
                    <span class="status-badge {{ route.status.value }}">{{ route.status.value }}</span>
                </td>
                <td>{{ route.mode.value }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No routes configured</p>
    {% endif %}
    <a href="/routes" class="btn">Manage Routes</a>
</section>

<script>
function refreshDiscovery() {
    const btn = document.getElementById('refresh-btn');
    const originalText = btn.textContent;
    btn.textContent = 'Refreshing...';
    btn.disabled = true;

    fetch('/api/discovery/refresh', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            btn.textContent = 'Refreshed!';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                // Reload page to show new devices
                window.location.reload();
            }, 1000);
        })
        .catch(err => {
            console.error('Discovery refresh error:', err);
            btn.textContent = 'Error';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        });
}

// Auto-refresh device status every 5 seconds
function updateStatus() {
    // Fetch sources
    fetch('/api/sources')
        .then(r => r.json())
        .then(sources => {
            sources.forEach(source => {
                const el = document.querySelector(`[data-source-id="${source.id}"]`);
                if (el) {
                    el.classList.toggle('online', source.online);
                    el.classList.toggle('offline', !source.online);
                }
            });
            // Update sources count
            const onlineSources = sources.filter(s => s.online).length;
            const sourceStat = document.getElementById('sources-stat');
            if (sourceStat) sourceStat.textContent = `${onlineSources} / ${sources.length}`;
        });

    // Fetch sinks
    fetch('/api/sinks')
        .then(r => r.json())
        .then(sinks => {
            sinks.forEach(sink => {
                const el = document.querySelector(`[data-sink-id="${sink.id}"]`);
                if (el) {
                    el.classList.toggle('online', sink.online);
                    el.classList.toggle('offline', !sink.online);
                }
            });
            // Update sinks count
            const onlineSinks = sinks.filter(s => s.online).length;
            const sinkStat = document.getElementById('sinks-stat');
            if (sinkStat) sinkStat.textContent = `${onlineSinks} / ${sinks.length}`;
        });
}

// Start auto-refresh
setInterval(updateStatus, 5000);
</script>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}
.page-header h1 {
    margin: 0;
}
</style>
{% endblock %}
