{% extends "base.html" %}

{% block title %}LED Preview - LTP Controller{% endblock %}

{% block content %}
<h1>LED Preview</h1>

<p class="subtitle">Live visualization of LED data</p>

{% if routes %}
<div class="preview-grid">
    {% for route in routes %}
    <div class="preview-card">
        <div class="preview-header">
            <h3>{{ route.name }}</h3>
            <span class="status-badge {{ route.status.value }}">{{ route.status.value }}</span>
        </div>
        <div class="preview-info">
            <span>
                {%- set source_name = route.source_id[:8] ~ '...' -%}
                {%- for source in sources if source.id == route.source_id -%}
                    {%- set source_name = source.name -%}
                {%- endfor -%}
                {%- for vs in virtual_sources if vs.id == route.source_id -%}
                    {%- set source_name = vs.name -%}
                {%- endfor -%}
                {%- set sink_name = route.sink_id[:8] ~ '...' -%}
                {%- for sink in sinks if sink.id == route.sink_id -%}
                    {%- set sink_name = sink.name -%}
                {%- endfor -%}
                {{ source_name }} &rarr; {{ sink_name }}
            </span>
            <span class="frame-count">Frames: <span id="frames-{{ route.id }}">{% if route.mode.value == 'direct' %}<em class="na-text">N/A</em>{% else %}{{ route._frames_routed }}{% endif %}</span></span>
        </div>
        <div class="led-preview" id="preview-{{ route.id }}">
            <img src="/api/routes/{{ route.id }}/preview" alt="LED Preview" class="led-strip">
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state-large">
    <p>No routes configured.</p>
    <p><a href="/routes">Create a route</a> to see LED previews.</p>
</div>
{% endif %}

<style>
.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
}

.preview-card {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid var(--border);
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.preview-header h3 {
    margin: 0;
}

.preview-info {
    display: flex;
    justify-content: space-between;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.na-text {
    color: var(--text-secondary);
    font-style: italic;
}

.led-preview {
    background: #111;
    border-radius: 4px;
    padding: 1rem;
    overflow-x: auto;
}

.led-strip {
    display: block;
    max-width: 100%;
    height: auto;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Refresh previews every 100ms for smooth animation
setInterval(() => {
    document.querySelectorAll('.led-strip').forEach(img => {
        const src = img.src.split('?')[0];
        img.src = src + '?t=' + Date.now();
    });
}, 100);

// Update frame counts every second (skip direct routes)
setInterval(() => {
    fetch('/api/routes')
        .then(r => r.json())
        .then(routes => {
            routes.forEach(route => {
                const el = document.getElementById('frames-' + route.id);
                if (el && route.mode !== 'direct') {
                    el.textContent = route.frames_routed;
                }
            });
        });
}, 1000);
</script>
{% endblock %}
