{% extends "base.html" %}

{% block title %}Routes - LTP Controller{% endblock %}

{% block content %}
<h1>Routes</h1>

<p class="subtitle">Configure data flow between sources and sinks</p>

<div class="actions-bar">
    <button class="btn btn-primary" onclick="showCreateModal()">Create Route</button>
</div>

{% if routes %}
<table class="table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Source</th>
            <th>Sink</th>
            <th>Dimensions</th>
            <th>Mode</th>
            <th>Status</th>
            <th>Frames</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for route in routes %}
        <tr data-route-id="{{ route.id }}">
            <td>{{ route.name }}</td>
            <td class="source-name" data-source-id="{{ route.source_id }}">
                {% for source in sources if source.id == route.source_id %}
                    {{ source.name }}
                {% else %}
                    {{ route.source_id[:8] }}...
                {% endfor %}
            </td>
            <td class="sink-name" data-sink-id="{{ route.sink_id }}">
                {% for sink in sinks if sink.id == route.sink_id %}
                    {{ sink.name }}
                {% else %}
                    {{ route.sink_id[:8] }}...
                {% endfor %}
            </td>
            <td id="dims-{{ route.id }}">
                <span class="dims-info">
                    {% if route._source_dims and route._sink_dims %}
                        {{ route._source_dims|join('x') }} &rarr; {{ route._sink_dims|join('x') }}
                        {% if route._scaling_active %}
                        <span class="scaling-badge" title="Scaling active: {{ route.transform.scale_mode.value }}">S</span>
                        {% endif %}
                    {% else %}
                        --
                    {% endif %}
                </span>
                <small class="warning-msg" id="nodata-{{ route.id }}" style="display: {% if route._no_data_warning %}block{% else %}none{% endif %}; color: var(--warning);">
                    No data
                </small>
            </td>
            <td>{{ route.mode.value }}</td>
            <td>
                <span class="status-badge {{ route.status.value }}" id="status-{{ route.id }}">{{ route.status.value }}</span>
                <small class="error-msg" id="error-{{ route.id }}" style="display: {% if route.error_message %}block{% else %}none{% endif %}; color: var(--danger);">
                    {{ route.error_message or '' }}
                </small>
            </td>
            <td id="frames-{{ route.id }}">{{ route._frames_routed }}</td>
            <td class="actions">
                {% if route.enabled %}
                <button class="btn btn-sm btn-warning" onclick="disableRoute('{{ route.id }}')">Disable</button>
                {% else %}
                <button class="btn btn-sm btn-success" onclick="enableRoute('{{ route.id }}')">Enable</button>
                {% endif %}
                <button class="btn btn-sm btn-danger" onclick="deleteRoute('{{ route.id }}')">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<style>
.scaling-badge {
    display: inline-block;
    background: var(--info, #17a2b8);
    color: white;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 0.7em;
    margin-left: 4px;
    cursor: help;
}
.dims-info {
    font-family: monospace;
    font-size: 0.9em;
}
.warning-msg {
    display: block;
    font-size: 0.8em;
}
</style>
{% else %}
<div class="empty-state-large">
    <p>No routes configured.</p>
    <p>Create a route to connect a source to a sink.</p>
</div>
{% endif %}

<!-- Create Route Modal -->
<div id="createModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create Route</h2>
            <button class="close-btn" onclick="hideCreateModal()">&times;</button>
        </div>
        <form id="createForm" onsubmit="createRoute(event)">
            <div class="form-group">
                <label for="name">Route Name</label>
                <input type="text" id="name" name="name" required placeholder="My Route">
            </div>
            <div class="form-group">
                <label for="source_id">Source</label>
                <select id="source_id" name="source_id" required>
                    <option value="">Select a source...</option>
                    {% for source in sources %}
                    <option value="{{ source.id }}" {% if not source.online %}disabled{% endif %}>
                        {{ source.name }} {% if not source.online %}(offline){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="sink_id">Sink</label>
                <select id="sink_id" name="sink_id" required>
                    <option value="">Select a sink...</option>
                    {% for sink in sinks %}
                    <option value="{{ sink.id }}" {% if not sink.online %}disabled{% endif %}>
                        {{ sink.name }} {% if not sink.online %}(offline){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="mode">Mode</label>
                <select id="mode" name="mode">
                    <option value="proxy">Proxy (through controller)</option>
                    <option value="direct">Direct (source to sink)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="scale_mode">Scale Mode</label>
                <select id="scale_mode" name="scale_mode">
                    <option value="fit">Fit (interpolate)</option>
                    <option value="pad_black">Pad Black (extend with black)</option>
                    <option value="pad_repeat">Pad Repeat (tile pattern)</option>
                    <option value="truncate">Truncate (cut to fit)</option>
                    <option value="stretch">Stretch</option>
                    <option value="none">None (pad/truncate)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="brightness">Brightness</label>
                <input type="range" id="brightness" name="brightness" min="0" max="1" step="0.05" value="1">
                <span id="brightnessValue">100%</span>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="hideCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
}

function hideCreateModal() {
    document.getElementById('createModal').style.display = 'none';
}

document.getElementById('brightness').addEventListener('input', function() {
    document.getElementById('brightnessValue').textContent = Math.round(this.value * 100) + '%';
});

function createRoute(event) {
    event.preventDefault();
    const form = event.target;
    const data = {
        name: form.name.value,
        source_id: form.source_id.value,
        sink_id: form.sink_id.value,
        mode: form.mode.value,
        transform: {
            brightness: parseFloat(form.brightness.value),
            scale_mode: form.scale_mode.value
        }
    };

    fetch('/api/routes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            location.reload();
        } else {
            alert('Error creating route: ' + (data.error || 'Unknown error'));
        }
    });
}

function enableRoute(id) {
    fetch(`/api/routes/${id}/enable`, { method: 'POST' })
        .then(() => location.reload());
}

function disableRoute(id) {
    fetch(`/api/routes/${id}/disable`, { method: 'POST' })
        .then(() => location.reload());
}

function deleteRoute(id) {
    if (confirm('Are you sure you want to delete this route?')) {
        fetch(`/api/routes/${id}`, { method: 'DELETE' })
            .then(() => location.reload());
    }
}

// Auto-refresh route status every second
function updateRouteStatus() {
    fetch('/api/routes')
        .then(r => r.json())
        .then(routes => {
            routes.forEach(route => {
                // Update status badge
                const statusEl = document.getElementById('status-' + route.id);
                if (statusEl) {
                    statusEl.textContent = route.status;
                    statusEl.className = 'status-badge ' + route.status;
                }

                // Update error message
                const errorEl = document.getElementById('error-' + route.id);
                if (errorEl) {
                    if (route.error_message) {
                        errorEl.textContent = route.error_message;
                        errorEl.style.display = 'block';
                    } else {
                        errorEl.style.display = 'none';
                    }
                }

                // Update frame count
                const framesEl = document.getElementById('frames-' + route.id);
                if (framesEl) {
                    framesEl.textContent = route.frames_routed;
                }

                // Update dimensions
                const dimsEl = document.getElementById('dims-' + route.id);
                if (dimsEl && route.source_dims && route.sink_dims) {
                    const srcDims = route.source_dims.join('x');
                    const sinkDims = route.sink_dims.join('x');
                    const scalingBadge = route.scaling_active ?
                        `<span class="scaling-badge" title="Scaling active: ${route.transform?.scale_mode || 'fit'}">S</span>` : '';
                    dimsEl.querySelector('.dims-info').innerHTML = `${srcDims} &rarr; ${sinkDims} ${scalingBadge}`;
                }

                // Update no-data warning
                const nodataEl = document.getElementById('nodata-' + route.id);
                if (nodataEl) {
                    nodataEl.style.display = route.no_data_warning ? 'block' : 'none';
                }
            });
        })
        .catch(err => console.error('Failed to update routes:', err));
}

// Update every second
setInterval(updateRouteStatus, 1000);
</script>
{% endblock %}
