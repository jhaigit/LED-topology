{% extends "base.html" %}

{% block title %}Scalar Sources - LTP Controller{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Scalar Sources</h1>
        <p class="subtitle">Sensor data sources (temperature, CPU metrics, GPIO, etc.)</p>
    </div>
    <button class="btn btn-primary" onclick="showCreateModal()">Create Scalar Source</button>
</div>

{% if scalar_sources %}
<div class="device-grid">
    {% for ss in scalar_sources %}
    <div class="device-card {% if ss.is_running %}online{% else %}offline{% endif %}">
        <div class="device-header">
            <span class="status-dot"></span>
            <h3>{{ ss.name }}</h3>
        </div>
        <p class="device-description">Type: {{ ss.source_type }}</p>

        <div class="device-details">
            <div class="detail-row">
                <span class="label">ID:</span>
                <span class="value id-value">{{ ss.id[:8] }}...</span>
            </div>
            <div class="detail-row">
                <span class="label">Channels:</span>
                <span class="value">{{ ss.total_channels }}</span>
            </div>
            <div class="detail-row">
                <span class="label">Sample Rate:</span>
                <span class="value">{{ ss.config.sample_rate }} Hz</span>
            </div>
            <div class="detail-row">
                <span class="label">Samples:</span>
                <span class="value" id="samples-{{ ss.id }}">{{ ss.samples_collected }}</span>
            </div>
            <div class="detail-row">
                <span class="label">Status:</span>
                <span class="value">{% if ss.is_running %}Running{% else %}Stopped{% endif %}</span>
            </div>
        </div>

        <div class="channel-preview" id="channels-{{ ss.id }}">
            <h4>Channel Values</h4>
            <div class="channel-bars">
                {% for ch in ss.channels %}
                <div class="channel-bar" data-channel-id="{{ ch.id }}">
                    <span class="channel-name">{{ ch.name }}</span>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: 0%"></div>
                    </div>
                    <span class="channel-value">-</span>
                    <span class="channel-unit">{{ ch.unit }}</span>
                </div>
                {% endfor %}
                {% for arr in ss.channel_arrays %}
                <div class="channel-array" data-array-id="{{ arr.id }}">
                    <span class="array-name">{{ arr.name }} ({{ arr.count }})</span>
                    <div class="array-bars">
                        {% for i in range(arr.count) %}
                        <div class="mini-bar" data-index="{{ arr.start_index + i }}">
                            <div class="mini-fill" style="height: 0%"></div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="device-controls">
            <h4>Controls</h4>
            <ul class="control-list" id="controls-{{ ss.id }}">
                {% for control in ss.controls.to_list() %}
                <li class="control-item" data-control-id="{{ control.id }}">
                    <span class="control-name">{{ control.name }}</span>
                    {% if control.type == 'number' and not control.readonly %}
                    <input type="range"
                           class="control-slider"
                           data-source-id="{{ ss.id }}"
                           data-control-id="{{ control.id }}"
                           min="{{ control.min }}"
                           max="{{ control.max }}"
                           step="{{ control.step }}"
                           value="{{ ss.controls.get_value(control.id) }}"
                           onchange="updateControl('{{ ss.id }}', '{{ control.id }}', parseFloat(this.value))">
                    <span class="control-value">{{ ss.controls.get_value(control.id) }}</span>
                    {% elif control.type == 'number' %}
                    <span class="control-value">{{ ss.controls.get_value(control.id) }} {{ control.unit or '' }}</span>
                    {% elif control.type == 'boolean' %}
                    <label class="toggle">
                        <input type="checkbox"
                               data-source-id="{{ ss.id }}"
                               data-control-id="{{ control.id }}"
                               {% if ss.controls.get_value(control.id) %}checked{% endif %}
                               onchange="updateControl('{{ ss.id }}', '{{ control.id }}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                    {% else %}
                    <span class="control-value">{{ ss.controls.get_value(control.id) }}</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="device-actions">
            {% if ss.is_running %}
            <button class="btn btn-sm btn-warning" onclick="stopSource('{{ ss.id }}')">Stop</button>
            {% else %}
            <button class="btn btn-sm btn-success" onclick="startSource('{{ ss.id }}')">Start</button>
            {% endif %}
            <button class="btn btn-sm" onclick="refreshSample('{{ ss.id }}')">Sample Now</button>
            <button class="btn btn-sm btn-danger" onclick="deleteSource('{{ ss.id }}')">Delete</button>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state-large">
    <p>No scalar sources created.</p>
    <p>Create a scalar source to collect sensor data (system metrics, environment, etc.).</p>
</div>
{% endif %}

<!-- Create Modal -->
<div id="createModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create Scalar Source</h2>
            <button class="close-btn" onclick="hideCreateModal()">&times;</button>
        </div>
        <form id="createForm" onsubmit="createSource(event)">
            <div class="form-group">
                <label for="ss-name">Name</label>
                <input type="text" id="ss-name" name="name" required placeholder="My Sensor">
            </div>
            <div class="form-group">
                <label for="ss-type">Type</label>
                <select id="ss-type" name="type" required>
                    <option value="">Select type...</option>
                    <option value="system_metrics">System Metrics (CPU, Memory, Disk, Network)</option>
                    <option value="environment">Environment (Temp, Humidity, Light, Motion)</option>
                    <option value="multi_zone">Multi-Zone Temperature</option>
                    <option value="gpio_input">GPIO Input (Digital)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="ss-rate">Sample Rate (Hz)</label>
                <input type="number" id="ss-rate" name="rate" value="1" min="0.1" max="100" step="0.1">
            </div>
            <div class="form-group">
                <label for="ss-description">Description</label>
                <input type="text" id="ss-description" name="description" placeholder="Optional description">
            </div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="hideCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store source IDs for live updates
const sourceIds = [{% for ss in scalar_sources %}'{{ ss.id }}'{% if not loop.last %}, {% endif %}{% endfor %}];

function showCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
}

function hideCreateModal() {
    document.getElementById('createModal').style.display = 'none';
}

function createSource(event) {
    event.preventDefault();
    const form = event.target;
    const data = {
        name: form.name.value,
        type: form.type.value,
        sample_rate: parseFloat(form.rate.value),
        description: form.description.value,
        enabled: true
    };

    fetch('/api/scalar-sources', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            location.reload();
        } else {
            alert('Error creating source: ' + (data.error || 'Unknown error'));
        }
    });
}

function updateControl(sourceId, controlId, value) {
    fetch(`/api/scalar-sources/${sourceId}/controls`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [controlId]: value })
    })
    .then(response => response.json())
    .then(data => {
        const li = document.querySelector(`#controls-${sourceId} [data-control-id="${controlId}"]`);
        if (li) {
            const valueSpan = li.querySelector('.control-value');
            if (valueSpan && typeof value === 'number') {
                valueSpan.textContent = value.toFixed(2);
            }
        }
    });
}

function refreshSample(sourceId) {
    fetch(`/api/scalar-sources/${sourceId}/sample`)
        .then(response => response.json())
        .then(data => {
            updateChannelDisplay(sourceId, data);
        });
}

function updateChannelDisplay(sourceId, data) {
    const container = document.getElementById(`channels-${sourceId}`);
    if (!container) return;

    const values = data.values;
    const channels = data.channels;
    const arrays = data.channel_arrays;

    // Update individual channels
    channels.forEach(ch => {
        const bar = container.querySelector(`[data-channel-id="${ch.id}"]`);
        if (bar) {
            const value = values[ch.index];
            const fill = bar.querySelector('.bar-fill');
            const valueSpan = bar.querySelector('.channel-value');

            // Calculate percentage
            let pct = 0;
            if (ch.min !== null && ch.max !== null && ch.max > ch.min) {
                pct = Math.min(100, Math.max(0, ((value - ch.min) / (ch.max - ch.min)) * 100));
            } else if (value >= 0) {
                pct = Math.min(100, value);
            }

            fill.style.width = pct + '%';
            valueSpan.textContent = typeof value === 'number' ? value.toFixed(2) : value;
        }
    });

    // Update channel arrays
    arrays.forEach(arr => {
        const arrayEl = container.querySelector(`[data-array-id="${arr.id}"]`);
        if (arrayEl) {
            for (let i = 0; i < arr.count; i++) {
                const idx = arr.start_index + i;
                const value = values[idx];
                const miniBar = arrayEl.querySelector(`[data-index="${idx}"]`);
                if (miniBar) {
                    const fill = miniBar.querySelector('.mini-fill');
                    let pct = 0;
                    if (arr.min !== null && arr.max !== null && arr.max > arr.min) {
                        pct = Math.min(100, Math.max(0, ((value - arr.min) / (arr.max - arr.min)) * 100));
                    } else if (value >= 0) {
                        pct = Math.min(100, value);
                    }
                    fill.style.height = pct + '%';
                }
            }
        }
    });
}

function startSource(id) {
    fetch(`/api/scalar-sources/${id}/start`, { method: 'POST' })
        .then(() => location.reload());
}

function stopSource(id) {
    fetch(`/api/scalar-sources/${id}/stop`, { method: 'POST' })
        .then(() => location.reload());
}

function deleteSource(id) {
    if (confirm('Are you sure you want to delete this scalar source?')) {
        fetch(`/api/scalar-sources/${id}`, { method: 'DELETE' })
            .then(() => location.reload());
    }
}

// Live update loop
function startLiveUpdates() {
    setInterval(() => {
        sourceIds.forEach(id => {
            fetch(`/api/scalar-sources/${id}/sample`)
                .then(response => response.json())
                .then(data => {
                    updateChannelDisplay(id, data);
                })
                .catch(() => {}); // Ignore errors
        });
    }, 1000);
}

// Start live updates when page loads
if (sourceIds.length > 0) {
    startLiveUpdates();
}
</script>
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}
.page-header h1 {
    margin: 0;
}
.page-header .subtitle {
    margin: 0.25rem 0 0 0;
    color: var(--text-secondary, #888);
}
.id-value {
    font-family: monospace;
    font-size: 0.85em;
}
.channel-preview {
    margin: 0.5rem 0;
    padding: 0.5rem;
    background: var(--bg-tertiary, #1a1a1a);
    border-radius: 4px;
}
.channel-preview h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9em;
}
.channel-bar {
    display: grid;
    grid-template-columns: 100px 1fr 60px 30px;
    gap: 0.5rem;
    align-items: center;
    margin: 0.25rem 0;
}
.channel-name {
    font-size: 0.85em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.bar-container {
    height: 12px;
    background: var(--bg-secondary, #222);
    border-radius: 2px;
    overflow: hidden;
}
.bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary, #007bff), var(--info, #17a2b8));
    transition: width 0.2s ease;
}
.channel-value {
    font-family: monospace;
    font-size: 0.85em;
    text-align: right;
}
.channel-unit {
    font-size: 0.75em;
    color: var(--text-secondary, #888);
}
.channel-array {
    margin: 0.5rem 0;
}
.array-name {
    display: block;
    font-size: 0.85em;
    margin-bottom: 0.25rem;
}
.array-bars {
    display: flex;
    gap: 2px;
    height: 30px;
    align-items: flex-end;
}
.mini-bar {
    flex: 1;
    height: 100%;
    background: var(--bg-secondary, #222);
    border-radius: 2px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
}
.mini-fill {
    width: 100%;
    background: linear-gradient(0deg, var(--success, #28a745), var(--warning, #ffc107));
    border-radius: 2px;
    transition: height 0.2s ease;
}
.control-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.25rem 0;
    border-bottom: 1px solid var(--border, #333);
}
.control-item:last-child {
    border-bottom: none;
}
.control-name {
    flex: 1;
    font-size: 0.9em;
}
.control-slider {
    width: 80px;
    margin: 0 0.5rem;
}
.control-value {
    min-width: 50px;
    text-align: right;
    font-family: monospace;
    font-size: 0.85em;
}
.toggle {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
}
.toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}
.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #333;
    transition: 0.2s;
    border-radius: 20px;
}
.toggle-slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.2s;
    border-radius: 50%;
}
.toggle input:checked + .toggle-slider {
    background-color: var(--success, #28a745);
}
.toggle input:checked + .toggle-slider:before {
    transform: translateX(20px);
}
</style>
{% endblock %}
