{% extends "base.html" %}

{% block title %}Sinks - LTP Controller{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Sinks</h1>
        <p class="subtitle">Discovered display devices on the network</p>
    </div>
    <button class="btn" onclick="refreshDiscovery()" id="refresh-btn">Refresh Discovery</button>
</div>

{% if sinks %}
<div class="device-grid">
    {% for sink in sinks %}
    <div class="device-card {% if sink.online %}online{% else %}offline{% endif %}">
        <div class="device-header">
            <span class="status-dot"></span>
            <h3>{{ sink.name }}</h3>
        </div>
        <p class="device-description">{{ sink.description or 'No description' }}</p>

        <div class="device-geometry">
            <span class="geometry-value">{{ sink.device.properties.pixels or '?' }} pixels</span>
            {% if sink.device.properties.color %}
            <span class="geometry-color">{{ sink.device.properties.color|upper }}</span>
            {% endif %}
        </div>

        <div class="device-details">
            <div class="detail-row">
                <span class="label">Address:</span>
                <span class="value">{{ sink.host }}:{{ sink.port }}</span>
            </div>
            <div class="detail-row">
                <span class="label">ID:</span>
                <span class="value">{{ sink.id[:8] }}...</span>
            </div>
            {% if sink.device.properties.type %}
            <div class="detail-row">
                <span class="label">Type:</span>
                <span class="value">{{ sink.device.properties.type }}</span>
            </div>
            {% endif %}
            {% if sink.device.properties.rate %}
            <div class="detail-row">
                <span class="label">Max Rate:</span>
                <span class="value">{{ sink.device.properties.rate }} Hz</span>
            </div>
            {% endif %}
        </div>

        {% if sink.controls %}
        <div class="device-controls">
            <h4>Controls</h4>
            <ul class="control-list">
                {% for control in sink.controls %}
                <li>
                    <span class="control-name">{{ control.name }}</span>
                    <span class="control-value">{{ sink.control_values.get(control.id, control.get('value', '-')) }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="device-actions">
            <button class="btn btn-sm" onclick="refreshDevice('sink', '{{ sink.id }}')">Refresh</button>
            {% if sink.online %}
            <button class="btn btn-sm btn-primary" onclick="showFillModal('{{ sink.id }}', '{{ sink.name }}', {{ sink.device.properties.pixels or sink.device.properties.dim|replace('x','*')|int if sink.device.properties.dim else 60 }})">Fill</button>
            <button class="btn btn-sm" onclick="clearSink('{{ sink.id }}')">Clear</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Fill Modal -->
<div id="fillModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Fill Sink: <span id="fillSinkName"></span></h2>
            <button class="close-btn" onclick="hideFillModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="fillSinkId">
            <input type="hidden" id="fillPixelCount">

            <div class="fill-tabs">
                <button class="tab-btn active" onclick="showFillTab('solid')">Solid</button>
                <button class="tab-btn" onclick="showFillTab('gradient')">Gradient</button>
                <button class="tab-btn" onclick="showFillTab('sections')">Sections</button>
            </div>

            <!-- Solid Fill Tab -->
            <div id="solidTab" class="fill-tab">
                <div class="form-group">
                    <label for="solidColor">Color</label>
                    <input type="color" id="solidColor" value="#ff0000">
                </div>
                <button class="btn btn-primary" onclick="fillSolid()">Apply</button>
            </div>

            <!-- Gradient Fill Tab -->
            <div id="gradientTab" class="fill-tab" style="display: none;">
                <div class="form-group">
                    <label>Start Color</label>
                    <input type="color" id="gradientStart" value="#ff0000">
                </div>
                <div class="form-group">
                    <label>End Color</label>
                    <input type="color" id="gradientEnd" value="#0000ff">
                </div>
                <button class="btn btn-primary" onclick="fillGradient()">Apply</button>
            </div>

            <!-- Sections Fill Tab -->
            <div id="sectionsTab" class="fill-tab" style="display: none;">
                <div id="sectionsList">
                    <div class="section-row">
                        <input type="number" class="section-start" placeholder="Start" min="0" value="0">
                        <input type="number" class="section-end" placeholder="End" min="0" value="30">
                        <input type="color" class="section-color" value="#ff0000">
                        <button class="btn btn-sm btn-danger" onclick="removeSection(this)">X</button>
                    </div>
                </div>
                <button class="btn btn-sm" onclick="addSection()">+ Add Section</button>
                <button class="btn btn-primary" onclick="fillSections()">Apply</button>
            </div>
        </div>
    </div>
</div>

<style>
.fill-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}
.tab-btn {
    padding: 8px 16px;
    border: 1px solid var(--border, #ccc);
    background: var(--bg-secondary, #f5f5f5);
    cursor: pointer;
    border-radius: 4px;
}
.tab-btn.active {
    background: var(--primary, #007bff);
    color: white;
    border-color: var(--primary, #007bff);
}
.fill-tab {
    padding: 16px 0;
}
.section-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
}
.section-row input[type="number"] {
    width: 80px;
}
#sectionsList {
    margin-bottom: 12px;
}
</style>

{% else %}
<div class="empty-state-large">
    <p>No sinks discovered on the network.</p>
    <p>Start an ltp-sink to see it here.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function refreshDevice(type, id) {
    fetch(`/api/${type}s/${id}/refresh`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                location.reload();
            }
        });
}

// Fill modal functions
function showFillModal(sinkId, sinkName, pixelCount) {
    document.getElementById('fillSinkId').value = sinkId;
    document.getElementById('fillSinkName').textContent = sinkName;
    document.getElementById('fillPixelCount').value = pixelCount;
    document.getElementById('fillModal').style.display = 'flex';

    // Update section end default
    document.querySelector('.section-end').value = pixelCount;
}

function hideFillModal() {
    document.getElementById('fillModal').style.display = 'none';
}

function showFillTab(tab) {
    // Hide all tabs
    document.querySelectorAll('.fill-tab').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

    // Show selected tab
    document.getElementById(tab + 'Tab').style.display = 'block';
    event.target.classList.add('active');
}

function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? [
        parseInt(result[1], 16),
        parseInt(result[2], 16),
        parseInt(result[3], 16)
    ] : [255, 255, 255];
}

function fillSolid() {
    const sinkId = document.getElementById('fillSinkId').value;
    const color = hexToRgb(document.getElementById('solidColor').value);

    fetch(`/api/sinks/${sinkId}/fill`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'solid', color: color })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') {
            hideFillModal();
        } else {
            alert('Error: ' + (data.message || data.error));
        }
    });
}

function fillGradient() {
    const sinkId = document.getElementById('fillSinkId').value;
    const startColor = hexToRgb(document.getElementById('gradientStart').value);
    const endColor = hexToRgb(document.getElementById('gradientEnd').value);

    fetch(`/api/sinks/${sinkId}/fill`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'gradient', colors: [startColor, endColor] })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') {
            hideFillModal();
        } else {
            alert('Error: ' + (data.message || data.error));
        }
    });
}

function fillSections() {
    const sinkId = document.getElementById('fillSinkId').value;
    const rows = document.querySelectorAll('.section-row');
    const sections = [];

    rows.forEach(row => {
        const start = parseInt(row.querySelector('.section-start').value);
        const end = parseInt(row.querySelector('.section-end').value);
        const color = hexToRgb(row.querySelector('.section-color').value);
        if (!isNaN(start) && !isNaN(end)) {
            sections.push({ start, end, color });
        }
    });

    fetch(`/api/sinks/${sinkId}/fill`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'sections', sections: sections })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'ok') {
            hideFillModal();
        } else {
            alert('Error: ' + (data.message || data.error));
        }
    });
}

function addSection() {
    const pixelCount = document.getElementById('fillPixelCount').value;
    const list = document.getElementById('sectionsList');
    const row = document.createElement('div');
    row.className = 'section-row';
    row.innerHTML = `
        <input type="number" class="section-start" placeholder="Start" min="0" value="0">
        <input type="number" class="section-end" placeholder="End" min="0" value="${pixelCount}">
        <input type="color" class="section-color" value="#00ff00">
        <button class="btn btn-sm btn-danger" onclick="removeSection(this)">X</button>
    `;
    list.appendChild(row);
}

function removeSection(btn) {
    const rows = document.querySelectorAll('.section-row');
    if (rows.length > 1) {
        btn.parentElement.remove();
    }
}

function clearSink(sinkId) {
    fetch(`/api/sinks/${sinkId}/clear`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.status !== 'ok') {
                alert('Error: ' + (data.message || data.error));
            }
        });
}

function refreshDiscovery() {
    const btn = document.getElementById('refresh-btn');
    const originalText = btn.textContent;
    btn.textContent = 'Refreshing...';
    btn.disabled = true;

    fetch('/api/discovery/refresh', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            btn.textContent = 'Refreshed!';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                window.location.reload();
            }, 1000);
        })
        .catch(err => {
            console.error('Discovery refresh error:', err);
            btn.textContent = 'Error';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        });
}
</script>
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}
.page-header h1 {
    margin: 0;
}
.page-header .subtitle {
    margin: 0.25rem 0 0 0;
}
.device-geometry {
    display: flex;
    gap: 0.75rem;
    margin: 0.75rem 0;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color, #333);
}
.device-geometry span {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
}
.geometry-value {
    background: var(--accent-color, #2563eb);
    color: white;
}
.geometry-color {
    background: var(--secondary-bg, #374151);
    color: var(--text-muted, #9ca3af);
    font-family: monospace;
}
</style>
{% endblock %}
